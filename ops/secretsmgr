#!/usr/bin/env bash
set -euo pipefail

# -----------------------------------------------------------------------------
# sopsctl - gum-based registry + .sops.yaml generator + secret editor
#
# Repo expectations:
#   ops/registry.yaml
#   secrets/default.yaml
#   secrets/systems/<host>.yaml
#   secrets/users/<user>.yaml
#
# Policy:
#   - masters can decrypt everything
#   - hosts can decrypt:
#       - secrets/default.yaml
#       - their own secrets/systems/<host>.yaml
#       - ALL secrets/users/<user>.yaml   <-- (your requested change)
#   - users can decrypt their own secrets/users/<user>.yaml
#
# Dependencies: gum, yq (mikefarah), sops
# -----------------------------------------------------------------------------

REGISTRY="${REGISTRY:-ops/registry.yaml}"
SOPS_YAML="${SOPS_YAML:-.sops.yaml}"

need() { command -v "$1" >/dev/null 2>&1 || { echo "missing: $1" >&2; exit 1; }; }

need gum
need yq
need sops

# -----------------------------------------------------------------------------
# UI helpers
# -----------------------------------------------------------------------------

choose_with_back() {
  local header="$1"; shift
  local selection
  selection="$(printf "%s\n" "$@" "← Back" | gum choose --header "$header")" || return 1
  [[ "$selection" == "← Back" ]] && return 1
  printf "%s" "$selection"
}

warn() { gum style --foreground 11 "$*"; }
ok()   { gum style --foreground 10 "$*"; }
err()  { gum style --foreground 9 "$*"; }

# -----------------------------------------------------------------------------
# Validation
# -----------------------------------------------------------------------------

require_registry() {
  if [[ ! -f "$REGISTRY" ]]; then
    err "Missing $REGISTRY"
    err "Create it first (example):"
    cat <<'EOF'
masters:
  ops: age1...
hosts: {}
users: {}
EOF
    exit 1
  fi
}

validate_name() {
  local name="$1"
  [[ "$name" =~ ^[a-z0-9_-]+$ ]]
}

validate_age_pubkey() {
  local key="$1"
  [[ "$key" =~ ^age1[0-9a-z]{20,}$ ]]
}

# -----------------------------------------------------------------------------
# Dedupe helpers
# -----------------------------------------------------------------------------

dedupe_lines() { awk 'NF && !seen[$0]++'; }

print_age_list() {
  local indent="$1"; shift
  [[ "$#" -eq 0 ]] && return 0
  printf "%s\n" "$@" | dedupe_lines | while IFS= read -r k; do
    printf "%s- %s\n" "$indent" "$k"
  done
}

# -----------------------------------------------------------------------------
# YAML generation
# -----------------------------------------------------------------------------

gen_sops_yaml() {
  require_registry

  local tmp
  tmp="$(mktemp)"

  mapfile -t master_keys < <(yq -r '.masters | to_entries | .[] | .value' "$REGISTRY" 2>/dev/null || true)
  mapfile -t host_names  < <(yq -r '.hosts | keys | .[]' "$REGISTRY" 2>/dev/null || true)
  mapfile -t user_names  < <(yq -r '.users | keys | .[]' "$REGISTRY" 2>/dev/null || true)

  if [[ "${#master_keys[@]}" -eq 0 ]]; then
    err "No masters defined in $REGISTRY. Add at least one under .masters"
    return 1
  fi

  # Precompute all host pubkeys (so we can add them to user secrets)
  host_keys=()
  for h in "${host_names[@]}"; do
    host_keys+=("$(yq -r ".hosts.${h}" "$REGISTRY")")
  done

  {
    echo "creation_rules:"

    # default.yaml => masters + ALL hosts
    echo "  - path_regex: ^secrets/default\\.ya?ml$"
    echo "    key_groups:"
    echo "      - age:"
    recipients=("${master_keys[@]}" "${host_keys[@]}")
    print_age_list "          " "${recipients[@]}"
    echo

    # systems/<host>.yaml => masters + that host
    for h in "${host_names[@]}"; do
      echo "  - path_regex: ^secrets/systems/${h}\\.ya?ml$"
      echo "    key_groups:"
      echo "      - age:"
      host_key="$(yq -r ".hosts.${h}" "$REGISTRY")"
      print_age_list "          " "${master_keys[@]}" "$host_key"
      echo
    done

    # users/<user>.yaml => masters + that user + ALL hosts   <-- change here
    for u in "${user_names[@]}"; do
      echo "  - path_regex: ^secrets/users/${u}\\.ya?ml$"
      echo "    key_groups:"
      echo "      - age:"
      user_key="$(yq -r ".users.${u}" "$REGISTRY")"
      print_age_list "          " "${master_keys[@]}" "${host_keys[@]}" "$user_key"
      echo
    done

    # catch-all safety net => masters only
    echo "  - path_regex: ^secrets/.*\\.ya?ml$"
    echo "    key_groups:"
    echo "      - age:"
    print_age_list "          " "${master_keys[@]}"
  } > "$tmp"

  mv "$tmp" "$SOPS_YAML"
  ok "Wrote $SOPS_YAML"
}

# -----------------------------------------------------------------------------
# Update keys across secrets
# -----------------------------------------------------------------------------

update_keys() {
  local files
  files="$(git ls-files 'secrets/**/*.yaml' 'secrets/**/*.yml' 2>/dev/null || true)"

  if [[ -z "$files" ]]; then
    warn "No secret files found under secrets/"
    return 0
  fi

  if gum confirm "Run 'sops updatekeys' on all secrets files?"; then
    # shellcheck disable=SC2086
    sops updatekeys $files
    ok "Updated keys in secrets/"
  fi
}

# -----------------------------------------------------------------------------
# Editing secrets
# -----------------------------------------------------------------------------

pick_editor() {
  if [[ -n "${EDITOR:-}" ]]; then
    echo "$EDITOR"
    return 0
  fi
  gum input --prompt "EDITOR not set. Enter editor command: " --placeholder "nvim / vim / nano / code -w"
}

ensure_file_dir() { mkdir -p "$(dirname "$1")"; }

create_encrypted_file_if_missing() {
  local path="$1"
  [[ -f "$path" ]] && return 0

  if gum confirm "Secret file missing: $path. Create encrypted file now?"; then
    ensure_file_dir "$path"
    echo "{}" | sops --encrypt /dev/stdin > "$path"
    ok "Created $path"
    return 0
  fi
  return 1
}

edit_secret_file() {
  local path="$1"
  local ed
  ed="$(pick_editor)" || return 1
  create_encrypted_file_if_missing "$path" || return 0
  SOPS_EDITOR="$ed" sops "$path"
}

edit_default_secret() { edit_secret_file "secrets/default.yaml"; }

edit_host_secret() {
  require_registry
  local hosts choice path
  hosts="$(yq -r '.hosts | keys | .[]' "$REGISTRY" 2>/dev/null || true)"
  [[ -n "$hosts" ]] || { warn "No hosts in registry"; return 0; }

  choice="$(printf "%s\n" $hosts "← Back" | gum choose --header "Edit which host secret?")" || return 0
  [[ "$choice" == "← Back" || -z "$choice" ]] && return 0

  path="secrets/systems/${choice}.yaml"
  edit_secret_file "$path"
}

edit_user_secret() {
  require_registry
  local users choice path
  users="$(yq -r '.users | keys | .[]' "$REGISTRY" 2>/dev/null || true)"
  [[ -n "$users" ]] || { warn "No users in registry"; return 0; }

  choice="$(printf "%s\n" $users "← Back" | gum choose --header "Edit which user secret?")" || return 0
  [[ "$choice" == "← Back" || -z "$choice" ]] && return 0

  path="secrets/users/${choice}.yaml"
  edit_secret_file "$path"
}

# -----------------------------------------------------------------------------
# Registry operations
# -----------------------------------------------------------------------------

list_entries() {
  require_registry
  gum style --bold "Masters"
  yq -r '.masters | to_entries | .[] | "  \(.key): \(.value)"' "$REGISTRY" || true
  echo
  gum style --bold "Hosts"
  yq -r '.hosts | to_entries | .[] | "  \(.key): \(.value)"' "$REGISTRY" || true
  echo
  gum style --bold "Users"
  yq -r '.users | to_entries | .[] | "  \(.key): \(.value)"' "$REGISTRY" || true
}

add_entry() {
  require_registry
  local kind="$1" name key

  name="$(gum input --prompt "${kind%s} name: " --placeholder "e.g. day / adam")" || return 1
  [[ -n "$name" ]] || return 1

  if ! validate_name "$name"; then
    err "Invalid name: '$name' (allowed: [a-z0-9_-])"
    return 1
  fi

  if yq -e ".${kind}.${name} != null" "$REGISTRY" >/dev/null 2>&1; then
    err "Already exists: ${kind}.${name}"
    return 1
  fi

  key="$(gum input --prompt "age public key: " --placeholder "age1...")" || return 1
  [[ -n "$key" ]] || return 1

  if ! validate_age_pubkey "$key"; then
    warn "Key doesn't look like an age public key (age1...). Saving anyway."
  fi

  if yq -e ".${kind} | to_entries | any(.value == \"${key}\")" "$REGISTRY" >/dev/null 2>&1; then
    warn "That key already exists under ${kind}. This is allowed, but double-check."
    gum confirm "Continue adding anyway?" || return 1
  fi

  yq -i ".${kind}.${name} = \"${key}\"" "$REGISTRY"
  ok "Added ${kind}.${name}"
}

remove_entry() {
  require_registry
  local kind="$1" choices choice

  choices="$(yq -r ".${kind} | keys | .[]" "$REGISTRY" 2>/dev/null || true)"
  [[ -n "$choices" ]] || { warn "No entries under ${kind}"; return 0; }

  choice="$(printf "%s\n" $choices "← Back" | gum choose --header "Remove which ${kind%s}?")" || return 0
  [[ "$choice" == "← Back" || -z "$choice" ]] && return 0

  if gum confirm "Remove ${kind}.${choice} from registry?"; then
    yq -i "del(.${kind}.${choice})" "$REGISTRY"
    ok "Removed ${kind}.${choice}"

    local f=""
    if [[ "$kind" == "hosts" ]]; then
      f="secrets/systems/${choice}.yaml"
    else
      f="secrets/users/${choice}.yaml"
    fi

    if [[ -f "$f" ]] && gum confirm "Archive secret file $f -> $f.bak ?"; then
      mv "$f" "$f.bak"
      ok "Archived $f"
    fi
  fi
}

# -----------------------------------------------------------------------------
# Submenus
# -----------------------------------------------------------------------------

hosts_menu() {
  while true; do
    local action
    action="$(choose_with_back "Hosts" \
      "Add host" \
      "Remove host" \
      "Edit host secret" \
      "Edit default.yaml")" || return 0

    case "$action" in
      "Add host")
        add_entry hosts || continue
        gen_sops_yaml || true
        update_keys || true
        ;;
      "Remove host")
        remove_entry hosts
        gen_sops_yaml || true
        update_keys || true
        ;;
      "Edit host secret") edit_host_secret ;;
      "Edit default.yaml") edit_default_secret ;;
    esac
  done
}

users_menu() {
  while true; do
    local action
    action="$(choose_with_back "Users" \
      "Add user" \
      "Remove user" \
      "Edit user secret")" || return 0

    case "$action" in
      "Add user")
        add_entry users || continue
        gen_sops_yaml || true
        update_keys || true
        ;;
      "Remove user")
        remove_entry users
        gen_sops_yaml || true
        update_keys || true
        ;;
      "Edit user secret") edit_user_secret ;;
    esac
  done
}

secrets_menu() {
  while true; do
    local action
    action="$(choose_with_back "Secrets" \
      "Edit default.yaml" \
      "Edit host secret" \
      "Edit user secret")" || return 0

    case "$action" in
      "Edit default.yaml") edit_default_secret ;;
      "Edit host secret") edit_host_secret ;;
      "Edit user secret") edit_user_secret ;;
    esac
  done
}

# -----------------------------------------------------------------------------
# Main
# -----------------------------------------------------------------------------

main() {
  require_registry

  while true; do
    local action
    action="$(gum choose \
      "List registry" \
      "Hosts…" \
      "Users…" \
      "Secrets…" \
      "Regenerate .sops.yaml" \
      "Update keys in secrets/" \
      "Quit" \
      --header "sops registry manager")"

    case "$action" in
      "List registry") list_entries ;;
      "Hosts…") hosts_menu ;;
      "Users…") users_menu ;;
      "Secrets…") secrets_menu ;;
      "Regenerate .sops.yaml") gen_sops_yaml ;;
      "Update keys in secrets/") update_keys ;;
      "Quit") exit 0 ;;
    esac
  done
}

main
